<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mother of Pearl Generator</title>
  <style>
    html, body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }

    canvas {
      display: block;
    }

    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 1rem;
      border-radius: 8px;
      z-index: 10;
    }

    label {
      display: block;
      margin-bottom: 0.3rem;
    }

    input[type="range"] {
      width: 150px;
    }

    button {
      margin-top: 0.5rem;
      padding: 4px 10px;
    }

    #progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      background: #88f;
      width: 0%;
      z-index: 20;
    }

    #status {
      position: fixed;
      top: 0;
      right: 0;
      padding: 0.4rem 1rem;
      font-size: 0.9rem;
      background: rgba(0, 0, 0, 0.6);
      z-index: 20;
    }
  </style>
</head>
<body>
<div id="controls">
  <label>Light Angle: <input type="range" id="lightAngle" min="0" max="1" step="0.01" value="0.5" /></label>
  <label>Noise Scale: <input type="range" id="scale" min="0.001" max="0.02" step="0.001" value="0.006" /></label>
  <label>Color Blend: <input type="range" id="blend" min="0.5" max="3" step="0.1" value="1.2" /></label>
  <button onclick="startGeneration()">Generate</button>
  <button onclick="exportPNG()">Export PNG</button>
</div>

<div id="progress"></div>
<div id="status">Idle</div>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/simplex-noise@2.4.0/simplex-noise.min.js"></script>
<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const progress = document.getElementById("progress");
  const status = document.getElementById("status");

  const simplex = new SimplexNoise();

  const palette = [
    { h: 290, s: 20, l: 85 },
    { h: 180, s: 20, l: 85 },
    { h: 60,  s: 20, l: 90 },
    { h: 330, s: 20, l: 88 },
    { h: 0,   s: 0,  l: 95 }
  ];

  function hslToRgb(h, s, l) {
    s /= 100;
    l /= 100;
    const k = n => (n + h / 30) % 12;
    const a = s * Math.min(l, 1 - l);
    const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
    return [Math.round(f(0) * 255), Math.round(f(8) * 255), Math.round(f(4) * 255)];
  }

  function blendPalette(value, sharpness = 1.2) {
    const scaled = value * (palette.length - 1);
    const index = Math.floor(scaled);
    const frac = Math.pow(scaled - index, sharpness);

    const c1 = palette[index % palette.length];
    const c2 = palette[(index + 1) % palette.length];

    const h = c1.h + (c2.h - c1.h) * frac;
    const s = c1.s + (c2.s - c1.s) * frac;
    const l = c1.l + (c2.l - c1.l) * frac;

    return hslToRgb(h, s, l);
  }

  let renderTask = null;

  function startGeneration() {
    if (renderTask) return;

    const width = canvas.width = window.innerWidth;
    const height = canvas.height = window.innerHeight;
    const imageData = ctx.createImageData(width, height);
    const data = imageData.data;

    const scale = parseFloat(document.getElementById("scale").value);
    const lightAngle = parseFloat(document.getElementById("lightAngle").value);
    const blendSharpness = parseFloat(document.getElementById("blend").value);

    const lightVec = {
      x: Math.cos(lightAngle * 2 * Math.PI),
      y: Math.sin(lightAngle * 2 * Math.PI)
    };

    let y = 0;
    status.innerText = "Rendering...";
    progress.style.width = "0%";

    renderTask = function renderLine() {
      for (let x = 0; x < width; x++) {
        const nx = x / width - 0.5;
        const ny = y / height - 0.5;
        const angleInfluence = nx * lightVec.x + ny * lightVec.y;
        const noise = simplex.noise2D(x * scale, y * scale);
        const value = (noise + angleInfluence * 1.5 + 1) / 2;

        const [r, g, b] = blendPalette(value, blendSharpness);
        const i = (y * width + x) * 4;
        data[i + 0] = r;
        data[i + 1] = g;
        data[i + 2] = b;
        data[i + 3] = 255;
      }

      y++;
      progress.style.width = `${(y / height) * 100}%`;

      if (y < height) {
        requestAnimationFrame(renderTask);
      } else {
        ctx.putImageData(imageData, 0, 0);
        status.innerText = "Complete";
        setTimeout(() => status.innerText = "Idle", 2000);
        renderTask = null;
      }
    };

    requestAnimationFrame(renderTask);
  }

  function exportPNG() {
    const link = document.createElement("a");
    link.download = "mother_of_pearl.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }

  // Start on load
  startGeneration();
</script>
</body>
</html>
